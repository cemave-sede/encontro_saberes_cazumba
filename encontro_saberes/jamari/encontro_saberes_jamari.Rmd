---
title: "Encontro dos Saberes FLONA do Jamari (2022)"
runningheader: "Análise mamíferos terrestres – 2014 a 2021" # only for pdf output
subtitle: "Análise mamíferos terrestres – 2014 a 2021" # only for html output
author: "Elildo Carvalho Jr - ICMBio/CENAP"
date: "`r Sys.Date()`"
output:
  tufte::tufte_html: default
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
#bibliography: skeleton.bib
#link-citations: yes
---

```{r setup, include=FALSE}
library(tufte)
# invalidate cache when the tufte version changes
knitr::opts_chunk$set(cache.extra = packageVersion('tufte'))
options(htmltools.dir.version = FALSE)
library(here)
knitr::opts_knit$set(root.dir = here("encontro_saberes", "jamari"))
```



```{r echo=FALSE, include = FALSE, message=FALSE, warning=FALSE}

# Carregar pacotes
library(here)
library(tidyverse)
library(lubridate)
library(R2jags)

# ler dados
jamari <- read_csv("Planilha Masto Aves Oficial Jamari 2014 a 2021.csv") 

# arrumar os dados
jamari <- jamari %>%
  rename(nome_UC = "Local - Nome da Unidade de Conservação",
         estacao_amostral = "Número da Estação Amostral",
         nome_ea = `Nome da EA`,
         esforco = "Esforço de amostragem tamanho da trilha (m)",
         data = "data da amostragem",
         ano = "Ano",
         classe = "Classe",
         ordem = "Ordem",
         familia = "Família",
         genero = "Gênero",
         especie = "Espécies validadas para análise do ICMBio",
         n_animais = "n° de animais",
         distancia = "distância (m)     do animal em relação a trilha") %>%
  select(nome_UC, estacao_amostral, nome_ea, esforco, data, ano, classe, ordem,
         familia, genero, especie, n_animais, distancia) %>%
  mutate(data = as.Date(data, "%d/%m/%Y"),
         distancia =  as.numeric(str_replace(distancia, ",", ".")) )
jamari

# checar especies e corrigir nomes se necessario
jamari %>%
  filter(classe == "Mammalia") %>% #, ordem != "Primates") %>%
  group_by(especie) %>%
  count() %>%
  arrange() %>%
  print(n=Inf)

jamari <- jamari %>%
  mutate(especie = replace(especie, especie %in% c("Guerlinguetus aestuans", "Urosciurus spadiceus"), 
                           "Sciuridae") )

# tabela esforco
tabela_esforco <- jamari %>%
  group_by(estacao_amostral, nome_ea, ano) %>%
  summarize(eff = sum(esforco, na.rm=TRUE)/1000) %>%
  ungroup() %>%
  pivot_wider(names_from = ano, values_from = eff) %>%
  rename('EA' = estacao_amostral, 'nome EA' = nome_ea)


# tabela 1: registros por especie
tabela_1 <- jamari %>%
  filter(classe == "Mammalia",
         ordem != "Primates") %>%
  group_by(especie) %>%
  summarize(n = n(),
            n_ind = sum(n_animais))%>%
  left_join(jamari %>%
              select(ordem, familia, especie), by="especie") %>%
  distinct(especie, .keep_all = TRUE) %>%
  arrange(ordem, familia, especie) %>%
  mutate(nome_popular = ifelse(especie == "Cabassous unicinctus", "Tatu-de-rabo-mole",
                        ifelse(especie == "Dasyprocta fuliginosa", "Cutia",
                        ifelse(especie == "Eira barbara", "Irara",
                        ifelse(especie == "Hydrochoerus hydrochaeris", "Capivara",
                        ifelse(especie == "Mazama americana", "Veado-mateiro",
                        ifelse(especie == "Mazama nemorivaga", "Veado-fuboca",
                        ifelse(especie == "Mazama sp.", "Veado",
                        ifelse(especie == "Myrmecophaga tridactyla", "Tamanduá-bandeira",
                        ifelse(especie == "Nasua nasua", "Quati",
                        ifelse(especie == "Panthera onca", "Onça-pintada",
                        ifelse(especie == "Pecari tajacu", "Caititu",
                        ifelse(especie == "Puma concolor", "Onça-vermelha",
                        ifelse(especie == "Puma yagouaroundi", "Gato-mourisco",
                        ifelse(especie == "Sciuridae", "Quatipuru",
                        ifelse(especie == "Sylvilagus brasiliensis", "Tapeti",
                        ifelse(especie == "Tamandua tetradactyla", "Mambira",
                        ifelse(especie == "Tapirus terrestris", "Anta",
                        ifelse(especie == "Tayassu pecari", "Queixada",
                        "no" ))))))))))))))))))) %>%
  select(ordem, familia, especie, nome_popular, n, n_ind) %>%
  rename(Ordem = ordem, Familia = familia, Especie = especie, 
         'Nome popular' = nome_popular, Encontros = n,
         Individuos = n_ind)


# esforco por ano
esforco_anual <- jamari %>%
  group_by(ano) %>%
  summarize(esforco = sum(esforco, na.rm = TRUE))

# numero de registros por ano
n_registros <- jamari %>%
  filter(classe == "Mammalia",
         ordem != "Primates") %>%
  group_by(ano, especie) %>%
  count()

# taxa de encontro por ano
taxa_encontro <- left_join(esforco_anual, n_registros, by=c("ano")) %>%
  mutate(taxa_encontro = n/(esforco/1000)) %>%
  select(ano, especie, taxa_encontro) %>%
  arrange(especie, ano)

# colocar em formato wide
taxa_encontro_wide <- taxa_encontro %>%
  pivot_wider(names_from = ano, values_from = taxa_encontro) %>%
  select(especie, `2014`, `2015`, `2016`, `2017`,  `2018`, `2019`, `2020`, `2021`) %>%
  replace(is.na(.), 0.001)

# selecionar as especies mais comuns (taxa media > 0.025)
taxa_encontro_wide <- taxa_encontro_wide %>%
  mutate(média = round(rowMeans(.[,2:9]),3)) %>%
  arrange(desc(média)) %>%
  filter(média >= 0.04) %>%
  #select(-média) %>%
  mutate_at(2:9, round, 2)

total_encontros_por_spp <- tabela_1 %>%
  filter(Encontros > 5) %>%
  ggplot(aes(x = reorder(`Nome popular`, -Encontros), y = Encontros)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("Espécie") + ylab("Número de encontros") +
  theme_bw() +
  theme(text = element_text(size=14))

```



## Apresentação

Este relatório apresenta resultados do Programa Monitora, Subprograma Terrestre, Componente Florestal Global, Alvo Mamíferos terrestres de médio e grande porte, protocolo básico, na **Floresta Nacional do Jamari**, 2014 a 2021. O principal objetivo é subsidiar o Encontro dos Saberes que será realizado nesta unidade.


## Métodos

O protocolo básico para mamíferos utiliza o método de transecções lineares. Resumidamente, dois observadores percorrem as transecções a uma velocidade constante e registram, para cada avistamento de animais dos grupos-alvo, a espécie, o número de indivíduos e a distância perperndicular entre o primeiro indivíduo avistado e o centro da trilha. Cada UC deve ter pelo menos três transectos de 5 km e o esforço anual mínimo, combinando todos os transectos, deve ser de 150 km percorridos. A tabela 1 apresenta o esforço anual por trilha na FLONA do Jamari.



```{r echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
library(kableExtra)
knitr::kable(
  tabela_esforco,
  caption = 'Tabela 1. Esforço de amostragem anual (em km) nas trilhas do Programa Monitora na FLONA do jamari, 2014-2021', booktabs = T, align = c("c", "l", "c")
  )
```


## Número total de encontros

A tabela 2 apresenta o número total de encontros e de indivíduos avistados por espécie. As espécies mais encontradas foram, nessa ordem: cutia, caititu, veado-fuboca, quatipuru e queixada. As outras espécies foram encontradas poucas (< 10) vezes. Para as espécies que vivem em grupos, o número indivíduos pode ser maior do que o número de encontros.

É importante lembrar que só porque uma espécie foi registrada poucas vezes, não quer dizer necessariamente que ela seja rara. Por exemplo, o protocolo não funciona bem para espécies noturnas como as antas e as pacas, pois as trilhas são percorridas durante o dia, quando essas espécies estão menos ativas. Além disso, espécies que são caçadas podem ficar muito ariscas, fugindo ao menor sinal da aproximação de pessoas.


```{r echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
library(kableExtra)
knitr::kable(
  tabela_1,
  caption = 'Tabela 2. Numero de registros por especie obtidos pelo protocolo básico do Programa Monitora na FLONA do Jamari, 2014-2021', booktabs = T, align = c("l", "l", "l", "l", "c")
  )
```


A Figura 1 apresenta o número total de encontros para as espécies que tiveram pelo menos 5 encontros ao longo de todo o monitoramento.


```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Figura 1. Número total de encontros por espécie na FLONA do Jamari, 2014-2021. Somente espécies com mais de 5 encontros foram incluídas"}
#include_graphics(here("encontro_saberes", "total_encontros_por_spp.jpeg"))
total_encontros_por_spp

```


# Tendências populacionais

Somente a cutia apresentou taxa de encontro anual média > 0.04 ind/km, o que equivale aproximadamente a um encontro a cada 25 km percorridos (Tabela 3). A Figura 2 mostra que há uma tendência de aumento na taxa de avistamento desta espécie ao longo do monitoramento.

As outras especies não tiveram número de encontros suficiente para permitir uma análise de suas tendências populacionais.


```{r, echo=FALSE, message=FALSE, warning=FALSE}
knitr::kable(
  taxa_encontro_wide,
  caption = 'Tabela 3. Taxas de encontro anuais para a cutia na FLONA do Jamari', booktabs = T, align = c("l", "c")
  )

```




```{r, echo=FALSE, include = FALSE, message=FALSE, warning=FALSE}

# funcao para gerar y por trilha para sp selecionada
calcular.registros.por.trilha <- function(nome_especie) {
  
  # esforco por ano por trilha
  esforco_anual_trilha <- jamari %>%
    group_by(ano, estacao_amostral) %>%
    summarize(esforco = sum(esforco, na.rm = TRUE)) %>%
    pivot_wider(names_from = ano, values_from = esforco) %>%
    select(estacao_amostral, `2014`, `2015`, `2016`, `2017`, `2018`, `2019`, `2020`, `2021`)
  esforco_anual_trilha
  
  # numero de registros por ano por trilha
  n_registros_trilha <- jamari %>%
    filter(especie == nome_especie) %>%
    group_by(ano, estacao_amostral) %>%
    count() %>%
    mutate(n = as.numeric(n)) %>%
    pivot_wider(names_from = ano, values_from = n) %>%
    select(estacao_amostral, `2014`, `2015`, `2016`, `2017`,  `2018`, `2019`, `2020`, `2021`) %>%
    replace(is.na(.), 0.001)
  n_registros_trilha
  
  # combinar registros e esforco para obter taxa de encontro
  esforco_anual_trilha <- esforco_anual_trilha %>%
    select(-estacao_amostral) %>%
    replace(is.na(.), 500) # inputar valor arbitrariamente alto para deixar numero de registros baixo mas !=0
  n_registros_trilha <- n_registros_trilha %>%
    ungroup() %>%
    select(-estacao_amostral)
  
  y <- n_registros_trilha/(esforco_anual_trilha/1000)
  
  return(y)
  
}

# funcao para rodar modelo populacional bayesiano
state.space.model <- function(y) {
  # especificar modelo na linguagem BUGS
  sink(here("encontro_saberes", "jamari", "ssm.jags"))
  cat("
  model {
  # Priors and constraints
  for(ea in 1:n_eas) {
  logN.est[ea, 1] ~ dnorm(0, 0.01)       # Prior for initial population size
  mean.r[ea] ~ dnorm(1, 0.001)             # Prior for mean growth rate
  }
  sigma.proc ~ dunif(0, 1)             # Prior for sd of state process
  sigma2.proc <- pow(sigma.proc, 2)
  tau.proc <- pow(sigma.proc, -2)
  sigma.obs ~ dunif(0, 1)              # Prior for sd of observation process
  sigma2.obs <- pow(sigma.obs, 2)
  tau.obs <- pow(sigma.obs, -2)
  
  # Likelihood
  # State process
  for (year in 1:(n_years-1)) {
    for(ea in 1:n_eas) {
      r[ea, year] ~ dnorm(mean.r[ea], tau.proc)
      logN.est[ea, year+1] <- logN.est[ea, year] + r[ea, year]
    }
   }
  # Observation process
    for (year in 1:n_years) {
      for(ea in 1:n_eas) {
        y[ea, year] ~ dnorm(logN.est[ea, year], tau.obs)
      }
   }
   
  # Population sizes on real scale
  for (year in 1:n_years) {
    for(ea in 1:n_eas) {
     N.est[ea, year] <- exp(logN.est[ea, year])/100
    }
  }
  
  # Derived parameter: mean encounter rate
  for(year in 1:n_years) {
      mean_N[year] <- mean(N.est[, year])
  }
    
  }
  ",fill = TRUE)
  sink()
  
  #  definir y
  y <-  y
  
  # definir numero de anos
  n_years <- ncol(y)
  
  # definir numero de trilhas (ea)
  n_eas <- nrow(y)
  
  # juntar os dados
  jags.data <- list(y = log(y*100), n_years = n_years, n_eas = n_eas)
  
  # Initial values
  #inits <- function(){
  #  list(sigma.proc = runif(1, 0, 1), mean.r = rnorm(1),
  #       sigma.obs = runif(1, 0, 1),
  #       LogN.est = rbind(c(rnorm(1, -0.5, 0.1), rep(NA, (n.years-1))),
  #                        c(rnorm(1, -0.5, 0.1), rep(NA, (n.years-1))),
  #                        c(rnorm(1, -0.5, 0.1), rep(NA, (n.years-1))) )
  #} 
  #inits()
  
  # Parametros monitorados
  parameters <- c("mean_N", "r", "mean.r", "sigma2.obs", "sigma2.proc", "N.est")
  
  # definicoes MCMC
  ni <- 25000
  nt <- 3
  nb <- 10000
  nc <- 3
  
  # chamar o JAGS a partir do R
  ssm <- jags(jags.data, inits=NULL, parameters, here("encontro_saberes", "jamari", "ssm.jags"), n.chains = nc, n.thin = nt, n.iter = ni, n.burnin = nb)
  
  # checar resultados
  print(ssm, digits = 2)
  
  # Probabiliade de N(2021) < N(2014)
  #mean(ssm$BUGSoutput$sims.list$N.est[,8] < ssm$BUGSoutput$mean$N.est[1])
  
  assign("N.est", ssm$BUGSoutput$sims.list$N.est, .GlobalEnv)
  assign("mean_N", ssm$BUGSoutput$sims.list$mean_N, .GlobalEnv) 
  assign("meanR", ssm$BUGSoutput$sims.list$mean.r, .GlobalEnv) 
  assign("ssm", ssm, .GlobalEnv)
  
}


# funcao para rodar modelo e gerar grafico para cada especie 
computar.plotar.taxa_encontro <- function(nome_especie) {
  
  # preparar dados
  y <- calcular.registros.por.trilha(nome_especie)
  n_years <- ncol(y)
  n_eas <- nrow(y)
  
  
  # rodar modelo bayesiano
  state.space.model(y)
  
  # computar quantis
  modelo_quantis <- as_tibble(mean_N) %>%
    pivot_longer(1:n_years, names_to = "year") %>%
    group_by(year) %>%
    summarize(quant025 = quantile(value, probs = 0.025),
              quant25 = quantile(value, probs = 0.25), 
              quant50 = quantile(value, probs = 0.5),
              quant75 = quantile(value, probs = 0.75),
              quant975 = quantile(value, probs = 0.975)) %>%
    mutate(ano = c(2014:2021))
  modelo_quantis
  
  # plotar com ribbons
  plot_tendencia <- ggplot() + 
    geom_ribbon(data=modelo_quantis, aes(x=ano, ymin=quant025, ymax=quant975),fill="coral", alpha=0.2) +
    geom_ribbon(data=modelo_quantis, aes(x=ano, ymin=quant25, ymax=quant75),fill="coral3", alpha=0.3) +
    geom_line(data=modelo_quantis, aes(x=ano, y=quant50), size=0.5, alpha=0.5) +
    geom_point(data=modelo_quantis, aes(x=ano, y=quant50), size=2, alpha=0.5) +
    #stat_smooth(data=modelo_quantis, aes(x=ano, y=quant50), method = "lm", formula = y ~ poly(x, 5), se = FALSE) +
    ylim(0, max(modelo_quantis$quant975)+0.05) +
    xlab("Ano") + 
    ylab("Taxa de encontro") +
    theme_bw() +
    theme(text = element_text(size=14)) #+
  #theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
  plot_tendencia
  
  # salvar jpeg
  #ggsave(paste(nome_especie, "2014 a 2021.jpeg", sep = " "))
  
  
  # plotar por transecto
  dim(N.est)
  N_trilha1 <- apply(N.est[,1,], 2, mean)
  N_trilha1[4:8] <- NA
  N_trilha2 <- apply(N.est[,2,], 2, mean)
  N_trilha3 <- apply(N.est[,3,], 2, mean)
  N_trilha3[c(4,7)] <- NA
  N_trilha4 <- apply(N.est[,4,], 2, mean)
  N_trilha4[2:4] <- NA
  N.est_por_trilha <- as_tibble(rbind(N_trilha1,
                                       N_trilha2,
                                       N_trilha3,
                                      N_trilha4)) %>%
    rename('2014' = V1,
           '2015' = V2, '2016' = V3, '2017' = V4,
           '2018' = V5, '2019' = V6, '2020' = V7, '2021' = V8) %>%
    mutate(trilha = c("Fazenda", "Potosi", "Jacundá", "do Zé")) %>%
    pivot_longer(1:n_years, names_to = "ano")
  N.est_por_trilha
  plot_tendencia_trilha <- ggplot() + 
    geom_line(data=N.est_por_trilha, aes(x=ano, y=value, group=trilha, color=trilha), size=3, alpha=0.5) +
    geom_point(data=N.est_por_trilha, aes(x=ano, y=value, group=trilha, color=trilha), size=5, alpha=0.5) +
    ylim(0, max(N.est_por_trilha$value)+0.05) +
    xlab("Ano") + 
    ylab("Taxa de encontro") +
    theme_bw() +
    theme(text = element_text(size=14))
  plot_tendencia_trilha
  
  # salvar jpeg
  #ggsave(paste(nome_especie, "2014 a 2021 por trilha.jpeg", sep = " "))
  
  assign("plot_tendencia", plot_tendencia, .GlobalEnv)
  assign("plot_tendencia_trilha", plot_tendencia_trilha, .GlobalEnv)
  
}

computar.plotar.taxa_encontro("Dasyprocta fuliginosa")

```



```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Figura 2. Taxa de encontro anual para cutia na FLONA do Jamari, 2014-2021"}
plot_tendencia

```


# Tendências populacionais por trilha

A análise anterior avaliou as tendências médias, agregando os dados de todas a trilhas. No entanto, também é importante avaliar o que acontece em cada trilha separadamente. A figura 3 mostra que as trilhas apresentam tendências razoavelmente parecidas, apesar de faltarem dados para algumas trilhas em alguns anos e haver certa variação entre as trilhas. 


```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Figura 3. Taxa de encontro anual para cutia por trilha na FLONA do Jamari, 2014-2021"}
plot_tendencia_trilha

```


# Perguntas e reflexões

As espécies mais comuns encontradas no monitoramento foram cutia, caititu, veado-fuboca, quatipuru e queixada. Isso está de acordo com a percepção da comunidade?

Como explicar o aumento na taxa de encontro de cutias, em especial depois de 2019? Aconteceu alguma coisa na região que possa explicar isso?

Porque é importante monitorar várias trilhas ao invés de apenas uma?

